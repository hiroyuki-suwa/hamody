<!DOCTYPE html>
<html>
<head prefix="og: https://ogp.me/ns#">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q0J9HV7HZF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Q0J9HV7HZF');
</script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>純正律キーボード - hamody -</title>
<meta name="description" content="純正律キーボード - hamody - (ハモディ) は、純正律 (Just Intonation) をはじめ、平均律や中全音律など複数の音律を切り替えて比較できるブラウザ上の鍵盤楽器です。" />
<meta property="og:url" content="https://storage.googleapis.com/hamody/index.html" />
<meta property="og:type" content="website" />
<meta property="og:title" content="純正律キーボード - hamody -" />
<meta property="og:description" content="純正律キーボード - hamody - (ハモディ) は、純正律 (Just Intonation) をはじめ、平均律や中全音律など複数の音律を切り替えて比較できるブラウザ上の鍵盤楽器です。" />
<meta property="og:site_name" content="純正律キーボード -hamody-" />
<meta property="og:image" content="https://storage.googleapis.com/hamody/hamody.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="純正律キーボード - hamody -" />
<meta name="twitter:description" content="純正律キーボード - hamody - (ハモディ) は、純正律 (Just Intonation) をはじめ、平均律や中全音律など複数の音律を切り替えて比較できるブラウザ上の鍵盤楽器です。">
<meta name="twitter:image" content="https://storage.googleapis.com/hamody/hamody.png" />
<meta property="fb:app_id" content="368157814228386" />
<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="favicon.ico" />
<link rel="icon" href="favicon.ico" />
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="manifest" href="manifest.json" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>

<style>
body {
  margin: 0;
  background: #444;
}

* {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  color: #eee;
}

.container {
  position: relative;
  width: 320px;
  margin: 0 auto 80px;
  padding: 0 0 150px;
  background: linear-gradient(to right, #222, #333);
  box-shadow: 0 0 8px 0 rgba(0,0,0,.8);
  transition: .5s ease-out;
}

.container .title {
  display: inline-block;
  margin: 4px 16px 16px;
  font-weight: 200;
  font-size: 36px;
  letter-spacing: 2px;
  color: #888;
}

.sustain {
  position: absolute;
  top: 4px;
  right: 20px;
  padding: 0;
  border: none;
  text-align: right;
}
.sustain legend {
  margin-right: -2px;
  margin-bottom: 4px;
  color: #aaa;
  font-size: 12px;
}
.sustain label span {
  color: #aaa;
  font-size: 14px;
}

.keys {
  width: 220px;
  margin: 0 8px 0 76px;
  background: #222;
  border-left: solid 6px #812;
}

.key {
  position: relative;
  cursor: pointer;
  display: block;
  border: none;
}
.key:focus {
  outline: 0;
}

.key.white {
  color: #555;
  width: 220px;
  height: 40px;
  margin: -13px 0;
  border-top-right-radius: 4px;
  border-bottom-right-radius: 4px;
  border-left: solid 1px #dcb;
  box-shadow: 0 0 2px 0 rgba(17,17,17,.95) inset;
  z-index: 1;
}
.key.white.e, .key.white.h { margin-top: 0; }
.key.white.f, .key.white.c { margin-bottom: 0; }
.key.white              { background: #f8f0e8; }
.key.white:hover        { background: #bcd; }
.key.white.active       { background: #e94; }
.key.white.active:hover { background: #abc; }

.key.black {
  color: #eee;
  width: 140px;
  height: 26px;
  border-top-right-radius: 4px;
  border-bottom-right-radius: 4px;
  border-top:    solid  4px #aaa;
  border-right:  solid 12px #222;
  border-bottom: solid  4px #333;
  border-left:   solid  1px #222;
  z-index: 2;
  box-shadow: 0 0 2px 0 rgba(255,255,255,.5) inset;
}
.key.black.c_sharp, .key.black.f_sharp { transform: translate(0, 4px); }
.key.black.d_sharp, .key.black.a_sharp { transform: translate(0, -4px); }
.key.black              { background: linear-gradient(to right, #222, #444); }
.key.black:hover        { background: #567; }
.key.black.active       { background: #e94; }
.key.black.active:hover { background: #456; }

.key .indicator {
  position: absolute;
  left: -64px;
  top: 50%;
  transform: translateY(-50%);
  display: inline-block;
  width: 30px;
  padding: 0 4px;
  font-family: Consolas, 'Courier New', Courier, monospace;
  font-size: 10px;
  font-weight: bold;
  background: #aa9;
  color: #222;
  text-align: right;
  box-shadow: 0 4px 4px -2px rgba(0,0,0,.5) inset;
  transition: .2s ease-out;
}
.key.active .indicator {
  background: #e94;
  color: #642;
}
.key.e .indicator, .key.h .indicator {
  transform: translateY(-16px);
}
.key.f .indicator, .key.c .indicator {
  transform: translate(0,0);
}

.version {
  position: absolute;
  margin: 0;
  bottom: 130px;
  right: 20px;
  z-index: 99;
}
.version small {
  font-size: 12px;
  color: #666;
}

.mute {
  position: fixed;
  bottom: 150px;
  left: 50%;
  transform: translate(-50%,0);
  padding: 16px 0;
  width: 300px;
  font-size: 20px;
  text-align: center;
  color: #eee;
  background: rgba(0,0,0,.6);
  border: solid 1px #eee;
  cursor: pointer;
  border-radius: 32px;
  z-index: 999;
  transition: .5s ease-out;
}
.mute:hover {
  background: rgba(0,0,0,.8);
}
.mute:focus {
  outline: 0;
}
.container.tone-settings-expanded + .mute {
  bottom: 0;
  transform: translate(-50%,-72px);
}

.footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  min-height: 60px;
  padding: 16px 0 32px;
  background: #555;
  color: #eee;
  text-align: center;
  box-shadow: 0 4px 4px -2px rgba(0,0,0,.5) inset;
  z-index: 99;
}
.footer-container {
  display: flexbox;
}
.footer .tone-settings .inharmonicity {
  display: inline-block;
  width: 480px;
  max-width: 100%;
  margin-bottom: 12px;
}
.footer .tone-settings .inharmonicity input#inharmonicity {
  width: calc(100% - 180px);
}
.footer .tone-settings .harmonics {
  display: flexbox;
  width: 320px;
  justify-content: center;
  align-items: center;
  margin: 0 auto;
}
.footer .tone-settings .harmonics label {
  display: flexbox;
}
.footer .tone-settings .harmonics span {
  display: inline-block;
  width: 40px;
  height: 20px;
  font-size: 12px;
}
.footer .tone-settings .harmonics .harmonics-level {
  width: 240px;
  height: 4px;
}
.footer .tone-settings .harmonics .harmonics-level::-webkit-slider-thumb {
  width: 14px;
  height: 14px;
}
.footer .temperament-settings * {
  transition: .5s ease-out;
}
.footer .temperament-settings .label {
  display: inline-block;
  margin: 8px 12px;
}
.footer .master-settings {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 12px 0;
}
.footer .master-settings .label.a {
  display: flex;
  align-items: center;
}
.footer .master-settings .label.a span {
  padding: 0 4px;
}

.container.tone-settings-expanded + * + * .temperament-settings * {
  opacity: 0;
}

select#temperament, select#inkey, input#tuningA {
  font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', 'Segoe UI', Geneva, Verdana, sans-serif;
  font-size: 20px;
  font-weight: bold;
  background: #e94;
  color: #642;
  padding: 2px;
  border: none;
  box-shadow: 0 4px 4px -2px rgba(0,0,0,.5) inset;
}
select#temperament option {
  text-align: center;
}
select#inkey:disabled {
  background: #765;
}
input#tuningA {
  text-align: right;
  width: 72px;
}
input#volume {
  width: calc(100% - 240px);
  max-width: 320px;
}
input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  background-color: #fff;
  height: 5px;
  width: 100%;
  border-radius: 6px;
}
input[type="range"]:focus,
input[type="range"]:active {
  outline: none;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
  position: relative;
  border: 2px solid rgba(0, 0, 0, .7);
  width: 22px;
  height: 22px;
  display: block;
  background-color: #fff;
  border-radius: 50%;
  -webkit-border-radius: 50%;
}
input[type="range"]:active::-webkit-slider-thumb {
  box-shadow: 0 0 0 4px rgba(255, 255, 255, .6);
}

.setting-pages-switcher {
  position: absolute;
  bottom: -8px;
  left: 8px;
}
.setting-pages-switcher .toggle-setting-pages {
  cursor: pointer;
}

.language-settings {
  position: absolute;
  bottom: -8px;
  right: 8px;
}
.language-settings .open-modal-language {
  cursor: pointer;
}

.copyright {
  position: fixed;
  margin: 0;
  bottom: 8px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 99;
}
.copyright small {
  font-size: 12px;
  color: #777;
}

.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: rgba(34,34,34,0.95);
  border: solid 1px #aaa;
  z-index: 9999;
}

.modal-language {
  display: none;
  padding: 60px 20px;
  width: 100vw;
  height: 100vh;
}
.modal-language .modal-container {
  position: absolute;
  width: 100%;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  text-align: center;
}
.modal-language h2 {
  width: calc(100%-60px);
  padding: 0 12px;
  color: #aaa;
  font-size: 32px;
  font-weight: 200;
}
.modal-language h2 small {
  color: #aaa;
  font-size: 16px;
}
.modal-language div {
  margin: 40px 0;
  text-align: center;
}
.modal-language #language {
  padding: 0 16px;
  color: #222;
  background-color: #ccc;
  font-size: 24px;
  font-weight: bold;
}
.modal-language .set-language {
  cursor: pointer;
  padding: 8px 48px;
  width: 240px;
  height: 60px;
  color: #ccc;
  background: #222;
  font-size: 24px;
  border: solid 1px #ccc;
  border-radius: 30px;
  transition: .3s ease-out;
}
.modal-language .set-language:hover {
  background: #111;
}
.modal-language .set-language:focus {
  outline: 0;
}

@media (min-width: 960px) {
  body {
    background: #cba;
  }
  .container {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-58%) rotate(90deg);
    margin: 0 auto 80px;
    padding: 0 0 60px;
    border-radius: 12px;
  }
  .container.tone-settings-expanded {
    transform: translate(-50%,-80%) rotate(90deg);
  }
  .mute {
    position: absolute;
    left: 50%;
    bottom: 50%;
    width: 1024px;
    height: 80px;
    border-radius: 40px;
    font-size: 40px;
    font-weight: 100;
    transition: .5s ease-out;
    transform: translate(-50%, calc(-58% + 270px));
  }
  .container.tone-settings-expanded + .mute {
    bottom: 20px;
  }
  .footer {
    min-height: 120px;
  }
  .footer .tone-settings .harmonics {
    transform: rotate(270deg) scale(1.25);
  }
  .footer .tone-settings .harmonics span {
    transform: rotate(90deg);
  }
  select#temperament, select#inkey, input#tuningA {
    font-size: 30px;
  }
  input#tuningA {
    width: 108px;
  }
  .version {
    bottom: 40px;
  }
  .copyright {
    bottom: 20px;
  }
}

@media (min-width: 1280px) {
  .container {
    transform: translate(-50%,-58%) rotate(90deg) scale(1.25);
  }
}

</style>
</head>

<body>
<div class="container">
  <h1 class="title">hamody</h1>

  <fieldset class="sustain">
    <legend>SUSTAIN MODE:</legend>
    <label class="on">
      <span>multiple</span>
      <input type="radio" name="sustain" value="on" checked>
    </label>
    <label class="off">
      <input type="radio" name="sustain" value="off">
      <span>single</span>
    </label>
  </fieldset>

  <div id="keys" class="keys"></div>

  <p class="version"><small>version X</small></p>
</div>

<button type="button" class="mute" hidden>mute all</button>

<footer class="footer">
  <div class="footer-container">
    <div class="tone-settings">
      <label class="inharmonicity">
        <span class="label">inharmonicity:</span>
        <code class="inharmonicity-value">0.00000</code>
        <input type="range" id="inharmonicity" min="0.00000" max="0.00500" step="0.00001" value="0.00000">
      </label>

      <div class="harmonics"></div>
    </div>

    <div class="temperament-settings">
      <span>
        <select id="temperament" name="temperament">
          <option value="equal" selected>Equal</option>
          <option value="pure">Pure</option>
          <option value="meantone">Meantone</option>
          <option value="Pythagorean">Pythagorean</option>
        </select>

        <label id="inkey-label" class="label inkey">
          <span>in</span>
          <select id="inkey" name="inkey" disabled>
            <option value="6">F#/Gb</option>
            <option value="5">F</option>
            <option value="4">E</option>
            <option value="3">Eb</option>
            <option value="2">D</option>
            <option value="1">Db</option>
            <option value="0" selected>C</option>
            <option value="11">B</option>
            <option value="10">Bb</option>
            <option value="9">A</option>
            <option value="8">Ab</option>
            <option value="7">G</option>
            <option value="6">F#/Gb</option>
          </select>
        </label>
      </span>
    </div>

    <div class="master-settings">
      <label class="label a">
        <span>A =</span>
        <input type="number" id="tuningA" value="442" min="110" max="1760">
        <span>Hz</span>
      </label>

      <span class="material-icons">volume_down</span>
      <input id="volume" type="range" min="0" max="1" step="0.001" value="0.10">
      <span class="material-icons">volume_up</span>
    </div>
  </div>

  <p class="setting-pages-switcher">
    <a class="toggle-setting-pages material-icons">settings</a>
  </p>

  <p class="language-settings">
    <a class="open-modal-language material-icons">language</a>
  </p>

  <p class="copyright">
    <small>&copy;2020 SUWAHIROYUKI</small>
  </p>
</footer>

<div class="modal modal-language">
  <div class="modal-container">
    <h2>Select your language.<br>
    <small>言語を選択してください</small></h2>
    <div>
      <select id="language"></select>  
    </div>
    <div>
      <button class="set-language">Get Started</button>
    </div>
  </div>
</div>

<script>
const octaves = 3; // Keyboard size (in octave).
const harmonics = 16; // harmonics size.
const offsetToTuningNote = 9 + Math.floor(octaves/2) * 12; // Number of keys between lowest note and tuning A.
const chromaticInterval = 1.0594630943592952645618252949463417007792043174941856285592084314; // 2^(1/12).
const notesInOctave = ['c', 'c_sharp', 'd', 'd_sharp', 'e', 'f', 'f_sharp', 'g', 'g_sharp', 'a', 'a_sharp', 'h'];
const centList = () => {
  const temperament = $('#temperament').val();
  switch (temperament) {
    case 'pure':
      return [0, +11.7, +3.9, +15.6, -13.7, -2.0, -9.8, +2.0, +13.7, -15.6, +17.9, -11.7];
    case 'meantone':
      return [0, +17.108, -6.843, +10.265, -13.686, +3.422, -20.529, -3.422, +13.686, +10.265, +6.843, -17.108];
    case 'Pythagorean':
      return [0, -9.775, +3.910, -5.865, +7.820, -1.955, -11.730, +1.955, -7.820, +5.865, -3.910, +9.775];
    default:
      return new Array(12).fill(0);
  }
};
const en = {
  sustain: 'SUSTAIN MODE:',
  sustains: {
    on: 'multiple',
    off: 'single',
  },
  temperaments: {
    equal: 'Equal',
    pure: 'Pure',
    meantone: 'Meantone',
    Pythagorean: 'Pythagorean',
  },
};
const ja = {
  sustain: '音の保持:',
  sustains: {
    on: '和音',
    off: '単音',
  },
  temperaments: {
    equal: '平均律',
    pure: '純正律',
    meantone: '中全音律',
    Pythagorean: 'ピタゴラス音律',
  },
};
const en_keys = {
  '0': 'C',
  '1': 'Db',
  '2': 'D',
  '3': 'Eb',
  '4': 'E',
  '5': 'F',
  '6': 'F#/Gb',
  '7': 'G',
  '8': 'Ab',
  '9': 'A',
  '10': 'Bb',
  '11': 'B',
};
const de_keys = {
  '0': 'C',
  '1': 'Des',
  '2': 'D',
  '3': 'Es',
  '4': 'E',
  '5': 'F',
  '6': 'Fis/Ges',
  '7': 'G',
  '8': 'As',
  '9': 'A',
  '10': 'B',
  '11': 'H',
};
const jp_keys = {
  '0': 'ド',
  '1': 'レ♭',
  '2': 'レ',
  '3': 'ミ♭',
  '4': 'ミ',
  '5': 'ファ',
  '6': 'ファ♯/ソ♭',
  '7': 'ソ',
  '8': 'ラ♭',
  '9': 'ラ',
  '10': 'シ♭',
  '11': 'シ',
};
const languages = {
  en: {
    ...en,
    keys: en_keys,
    name: 'English'
  },
  ja_de: {
    ...ja,
    keys: de_keys,
    name: '日本語（ドイツ音名）'
  },
  ja_en: {
    ...ja,
    keys: en_keys,
    name: '日本語（英語音名）'
  },
  ja_jp: {
    ...ja,
    keys: jp_keys,
    name: '日本語（ドレミ表記）'
  }
};
const default_lang = 'en';
const getStoredLanguage = () => localStorage.getItem('language');
const getLanguage = () => $('#language').val() || default_lang;
const getTexts = language => languages[language || getLanguage()];
const getTuningA = () => parseFloat($('#tuningA').val()) || 442;
const getKey = () => parseInt($('#inkey').val()) || 0;
const getCent = index => centList()[(index - getKey() + 12) % 12] || 0;
const getVolume = () => parseFloat($('#volume').val());
const getInharmonicity = () => parseFloat($('#inharmonicity').val());
const getHarmonicsLevels = () => {
  return new Array(harmonics).fill().map((_, i) => {
    const level = $('.harmonics-level').filter(`.no${i+1}`).first().val();
    return parseFloat(level);
  });
};
const frequency = (f, n) => {
  const b = getInharmonicity();
  return n * f * Math.sqrt(1 + b * n * n) / Math.sqrt(1 + b);
}
const isSustainOn = () => $('input[name=sustain]:checked').val() === 'on';
let isLanguageSet = !!getStoredLanguage();
let context;
let notes = (new Array(12 * octaves + 1))
  .fill()
  .map((_, index) => {
    const key = notesInOctave[index % 12];
    const relativeFrequency = chromaticInterval ** (index - offsetToTuningNote);
    const sound = new Array(harmonics).fill({});
    const isActive = false;
    return {index, key, relativeFrequency, sound, isActive };
  });

const createSound = (baseFrequency, cent = 0) => {
  const harmonicsLevels = getHarmonicsLevels();
  const masterLevel = getVolume();
  return new Array(harmonics).fill().map((_, i) => {
    const n = i + 1;
    const oscillator = context.createOscillator();
    const gain = context.createGain();
    gain.connect(context.destination);
    oscillator.connect(gain);
    oscillator.start = oscillator.start || oscillator.noteOn;
    oscillator.stop  = oscillator.stop  || oscillator.noteOff;
    oscillator.type = 'sine';
    oscillator.frequency.value = frequency(baseFrequency, n);
    oscillator.detune.value = cent;
    gain.gain.value = masterLevel * harmonicsLevels[i];
    return { oscillator, gain };
  });
};

const createSoundFor = index => {
  const baseFrequency = getTuningA() * notes[index].relativeFrequency;
  const cent = getCent(index);
  return createSound(baseFrequency, cent);
};

const updateSound = (sound, baseFrequency, cent) => {
  const harmonicsLevels = getHarmonicsLevels();
  const masterLevel = getVolume();
  return sound.map(({ oscillator, gain }, i) => {
    const n = i + 1;
    oscillator.frequency.value = frequency(baseFrequency, n);
    oscillator.detune.value = cent;
    gain.gain.value = masterLevel * harmonicsLevels[i];
    return { oscillator, gain };
  });
};

const updateSoundFor = (sound, index) => {
  const baseFrequency = getTuningA() * notes[index].relativeFrequency;
  const cent = getCent(index);
  return updateSound(sound, baseFrequency, cent);
};

const refreshSounds = () => {
  notes = notes.map((note, index) => {
    if (!note.isActive) return note;
    const sound = updateSoundFor(note.sound, index);
    return { ...note, sound };
  });
};

const refreshIndicators = () => {
  const inkey = parseInt($('#inkey').val());
  $('.key').each(function() {
    const index = parseInt($(this).data('index'));
    const cent = getCent(index);
    const value = (cent > 0 ? '+' : '') + cent.toFixed(1);
    $(this).find('.indicator').text(value);
  });
};

const mute = index => {
  if (notes[index].isActive) {
    notes[index].sound = notes[index].sound.map(({ oscillator }) => {
      if (oscillator) oscillator.stop();
      return {}
    });
    notes[index].isActive = false;
  }
  $('.key').each(function() {
    if (parseInt($(this).data('index')) === index)
      $(this).removeClass('active');
  });
};

const dispatch = index => {
  if (!context) {
    context = new (window.AudioContext || window.webkitAudioContext);
  }
  mute(index);
  const sound = createSoundFor(index);
  sound.forEach(({oscillator}) => {
    if (oscillator) oscillator.start();
  });
  notes[index].sound = sound;
  notes[index].isActive = true;
  $('.key').each(function() {
    if (parseInt($(this).data('index')) === index)
      $(this).addClass('active');
  });
  $('.mute').removeAttr('hidden');
};

const muteAll = () => {
  notes.forEach((note, index) => {
    if (note.isActive) mute(index);
  });
  $('.mute').attr('hidden', true);
};

const initTexts = () => {
  const language = getStoredLanguage();
  const t = getTexts(language || default_lang);
  $('.sustain legend').text(t.sustain);
  Object.keys(t.sustains).forEach(index => {
    $(`.sustain .${index} span`).text(t.sustains[index]);
  });
  Object.keys(t.temperaments).forEach(index => {
    $(`#temperament option[value="${index}"]`)
      .text(t.temperaments[index]);
  });
  Object.keys(t.keys).forEach(index => {
    $(`#inkey option[value="${index}"]`)
      .text(t.keys[index]);
  });
};

const refreshInharmonicityValue = (e) => {
  const value = parseFloat($(e.target).val());
  const text = value ? (value + '00000').slice(0,7) : '0.00000';
  $('.inharmonicity-value').text(text);
}

const initKeys = () => {
  const $keys = notes.map(note => {
    const $key = $('<button>')
      .addClass('key')
      .addClass(note.key.includes('sharp') ? 'black' : 'white')
      .addClass(note.key)
      .data('index', note.index.toString())
      .on('click', (e) => {
        e.preventDefault();
        const attacked = !$(e.target).hasClass('active');
        if (!isSustainOn()) muteAll();
        if (attacked) dispatch(note.index);
        else mute(note.index);
        if (!$('.key.active').length) $('.mute').attr('hidden', true);
      });
    const $indicator = $('<code>')
      .addClass('indicator')
      .text('0.0');
    return $key.append($indicator);
  });
  $('#keys').append($keys.reverse());
};

const initLanguageSettingModal = () => {
  Object.keys(languages).forEach(language => {
    $('<option>').attr('value', language).text(languages[language].name).appendTo($('#language'));
  });
  $('#language').on('change', (e) => {
    if (isLanguageSet) return;
    const language = $(e.target).val();
    switch (language) {
      case 'ja_en':
      case 'ja_de':
      case 'ja_jp':
        $('.set-language').text('はじめる');
        break;
      default:
        $('.set-language').text('Get Started');
        break;
    }
  });
  $('.set-language').on('click', (e) => {
    e.preventDefault();
    $('.set-language').text('OK');
    localStorage.setItem('language', getLanguage());
    isLanguageSet = true;
    initTexts();
    $('.modal-language').hide();
  });
  $('.open-modal-language').on('click', (e) => {
    e.preventDefault();
    $('.modal-language').fadeIn();
  });
  if (isLanguageSet) {
    $('#language').val(getStoredLanguage());
    $('.set-language').text('OK');
  } else {
    $('.modal-language').show();
  }
};

const initFooter = () => {
  const $harmonics = $('.harmonics');
  Array(harmonics).fill().forEach((_, i) => {
    const $label = $('<label>');
    const $span = $('<span>').text(i + 1);
    const $input = $('<input>')
      .addClass('harmonics-level')
      .addClass(`no${i + 1}`)
      .attr('type', 'range')
      .attr('min', 0)
      .attr('max', 1)
      .attr('step', 0.001)
      .val(.5 / (i + 1) / (i + 1));
    $harmonics.append(
      $label.append($span).append($input)
    );
  });
  $('#temperament,#inkey').on({
    input: refreshIndicators,
    change: refreshIndicators,
    blur: refreshIndicators,
  });
  $('#temperament,#inkey,#tuningA,#volume,#inharmonicity,.harmonics-level').on({
    input: refreshSounds,
    change: refreshSounds,
    blur: refreshSounds,
  });
  $('#inharmonicity').on({
    input: refreshInharmonicityValue,
    change: refreshInharmonicityValue,
    blur: refreshInharmonicityValue,
  });
  $('.mute,.sustain,.sustain input')
    .on('click', muteAll);
  $('#temperament').on('change', (e) => {
    const temperament = $(e.target).val();
    const disabled = temperament === 'equal';
    $('#inkey').attr('disabled', disabled);
    $('#inkey-label').css('visibility', disabled ? 'hidden': '');
  });
  $('#inkey-label').css('visibility', 'hidden');
  $('.tone-settings').hide();
  $('.toggle-setting-pages').on('click', () => {
    $('.tone-settings').slideToggle();
    $('.container').toggleClass('tone-settings-expanded')
  });
  $('.version small').text(`version ${version}`);
};

$(() => {
  initTexts();
  initKeys();
  initLanguageSettingModal();
  initFooter();
});

const version = '1.2.0';
</script>
</body>
</html>
